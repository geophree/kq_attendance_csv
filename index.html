<html lang="en-US">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 10 10%22><text y=%22.9em%22 font-size=%229%22>üëç</text></svg>" />
  <title>KQ Attendance CSV Maker</title>
  <!-- from http://github.com/kevquirk/simple.css -->
  <link rel="stylesheet" href="https://unpkg.com/simpledotcss/simple.css" />
  <style>
    /* make the GitHub icon a normal size */
    .icon {
        vertical-align: sub;
        /* this makes them smaller for some reason:
        padding-right: .25rem; */
        display: inline-block;
        width: 1em;
        height: 1.3em;
        /* margin-right: 0.2rem;*/
        stroke-width: 0;
        stroke: currentColor;
        fill: currentColor;
    }

    /* fix some weirdness with buttons in simple.css */
    a.button,
    input[type="submit"],
    input[type="reset"],
    input[type="button"] {
      padding: .5em;
    }

    @media only screen and (max-width: 720px) {
      button, a.button, .button {
        text-align: center;
        width: 100%;
      }
    }

    /* turn off zebra striping of tables */
    tr:nth-child(even) {
      background-color: inherit;
    }

    /* make action-table work better with simple.css */
    action-table {
      th {
        &:has(> button) {
          padding: 0;
        }

        > button {
          text-align: left;
          border: none;
          border-radius: 0;
          /*
          background-color: inherit;
          color: inherit;
          &:hover {
            color: var(--accent-text);
          }
          */
          margin: 0;
          min-width: 100%;
        }
      }
    }

    /* Action table sorting display support */
    action-table {
      th button {
        display: flex;
        column-gap: .5em;
      }

      :where(th button)::after {
        content: "‚≠•" / "";
        margin-left: auto;
        opacity: .3;
      }

      :where(th[aria-sort="descending"] button)::after {
        content: "‚≠£" / "";
        opacity: 1;
      }

      :where(th[aria-sort="ascending"] button)::after {
        content: "‚≠°" / "";
        opacity: 1;
      }

      :where(
          th[aria-sort$="ing"] button,
          th[aria-sort$="ing"]:has(button)
        ) {
        background-color: var(--accent-hover);
      }

      .sorted {
        background-color: var(--accent-bg);
      }
    }

    /* title, search, bottom controls */
    action-table {
      display: block;
      width: fit-content;
      max-width: 100%;

      /* match action-table styles */
      .title, .controls {
        overflow: auto;
        width: 100%;
        font-weight: bold;
        background-color: var(--accent);
        border: var(--border-width) solid var(--border);
        padding: .5rem;
        color: var(--accent-text);
        font-size: medium; /* TODO: hack? */
      }

      /* expanding search */
      .title input[type="search"] {
        float: right;
        margin: 0;
        padding: .25em;

        &::placeholder {
          float: left;
        }

        &:placeholder-shown:not(:focus) {
          width: 2rem;
        }
      }

      .controls {
        display: flex;
        padding-bottom: 0; /* TODO: HACK! */

        :last-child {
          margin-left: auto;
        }

        button, .button {
          width: fit-content;
        }
      }

      &.editing .controls [name="edit"] {
        background-color: var(--bg);
        color: var(--text);
      }
    }

    /* scrolling & expanding table */
    action-table {
      .scroller {
        overflow: auto;
        max-height: 50vh;
        width: 100%;

        table {
          min-width: 100%;
          margin: 0;
        }

        /* always show header */
        thead {
          position: sticky;
          top: 0;
          td, th {
            border-top: none;
            border-bottom: none;
          }
        }

        tbody {
          tr:last-of-type :is(td, th) {
            border-bottom: none;
          }
        }
      }

      .controls label.expanded {
        &::after {
          content: "‚ñº";
        }
        &:has(:checked)::after {
          content: "‚ñ≤";
        }
      }

      &:has(label.expanded :checked) .scroller {
        max-height: none;
      }
    }


    /* my own styles */
    textarea {
      min-height: 10rem;
      /* might want to add this to simple.css for :not([cols]) */
      resize: vertical;
    }
    textarea::placeholder {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    p {
      text-wrap: pretty;
    }
    h1, h2, h3, h4, h5, h6 {
      text-wrap: balance;
    }

    /* section styling */
    section {
      &[data-stage="csv"] {
        button[name="csv_input"] {
          display: none;
        }

        super-table {
          display: none;
        }
      }

      &[data-stage="table"] {
        csv-input {
          display: none;
        }
      }
      &[data-name="reformat"]:not([data-step="start"]) {
        button[name="select"] {
          display: none;
        }
      }
      &[data-name="reformat"][data-step="start"] {
        button[name="reset"], button[name="add"], button[name="generate"] {
          display: none;
        }
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>KQ Attendance CSV Maker</h1>
    <p>A web app to transform the message reaction CSV into the attendance CSV.</p>
  </header>
  <main>
    <section data-filename="discord_id_to_nickname" data-stage="csv">
      <h2>Nickname Map</h2>
      <button name="csv_input">Back to Input</button>
      <csv-input></csv-input>
    </section>
    <section data-filename="message_reactions" data-stage="csv">
      <h2>Message Reactions</h2>
      <button name="csv_input">Back to Input</button>
      <csv-input></csv-input>
    </section>
    <section data-name="combined">
      <h2>Combined with Emoji columns</h2>
      <button name="generate">Generate</button>
      <!-- TODO: display when it is out of date? -->
    </section>
    <section data-name="reformat" data-step="start">
      <h2>Reformatted for Script</h2>
      <button name="select">Select Columns</button>
      <button name="reset">Reset</button>
      <button name="add" aria-label="add"><svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 448 512"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2026 Fonticons, Inc.--><path d="M256 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 160-160 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l160 0 0 160c0 17.7 14.3 32 32 32s32-14.3 32-32l0-160 160 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-160 0 0-160z"/></svg></button>
      <button name="generate">Generate</button>
      <!-- TODO: display when it is out of date? -->
    </section>
  </main>
  <footer>
    <nav>
      <a href="https://github.com/geophree/kq_attendance_csv"><svg class="icon" viewBox="0 0 32 32"><path d="M16 0.395c-8.836 0-16 7.163-16 16 0 7.069 4.585 13.067 10.942 15.182 0.8 0.148 1.094-0.347 1.094-0.77 0-0.381-0.015-1.642-0.022-2.979-4.452 0.968-5.391-1.888-5.391-1.888-0.728-1.849-1.776-2.341-1.776-2.341-1.452-0.993 0.11-0.973 0.11-0.973 1.606 0.113 2.452 1.649 2.452 1.649 1.427 2.446 3.743 1.739 4.656 1.33 0.143-1.034 0.558-1.74 1.016-2.14-3.554-0.404-7.29-1.777-7.29-7.907 0-1.747 0.625-3.174 1.649-4.295-0.166-0.403-0.714-2.030 0.155-4.234 0 0 1.344-0.43 4.401 1.64 1.276-0.355 2.645-0.532 4.005-0.539 1.359 0.006 2.729 0.184 4.008 0.539 3.054-2.070 4.395-1.64 4.395-1.64 0.871 2.204 0.323 3.831 0.157 4.234 1.026 1.12 1.647 2.548 1.647 4.295 0 6.145-3.743 7.498-7.306 7.895 0.574 0.497 1.085 1.47 1.085 2.963 0 2.141-0.019 3.864-0.019 4.391 0 0.426 0.288 0.925 1.099 0.768 6.354-2.118 10.933-8.113 10.933-15.18 0-8.837-7.164-16-16-16z"></path></svg> GitHub</a>
    </nav>
  </footer>
  <script type="module" src="https://unpkg.com/@colinaut/action-table/dist/index.js"></script>
  <script type="module" src="./super_table.js"></script>
  <script type="module" src="./csv_input.js"></script>
  <script type="module">
    // TODO: make sure all rows have the same column count
    // TODO: ignore empty lines
    import Csv from "./papaparse.js";
    const sections = document.querySelectorAll('section[data-stage]');

    const cec = (name) => (text) => {
      const el = document.createElement(name);
      if (text) el.textContent = text;
      return el;
    }

    const build_table = (rows) => {
      const table = cec('table')();
      const thead = cec('thead')();
      const tr = cec('tr')();
      tr.append(...rows[0].map(cec('th')));
      thead.append(tr);
      table.append(thead);

      const tbody = cec('tbody')();
      if (rows.length > 1) {
        for (let i = 1; i < rows.length; i++) {
          const tr = cec('tr')();
          tr.append(...rows[i].map(cec('td')));
          tbody.append(tr);
        }
      }
      table.append(tbody);
      return table;
    };

    for (const section of sections) {
      const backButton = section.querySelector('[name=csv_input]');
      backButton.addEventListener('click', (e) => {
        const superTable = section.querySelector('super-table');
        const csvInput = section.querySelector('csv-input');
        csvInput.querySelector('form').content.value = superTable.getCsv();
        section.dataset.stage = 'csv';
        superTable.remove();
      });

      const csvInput = section.querySelector('csv-input');
      csvInput.addEventListener('submit', (e) => {
        e.preventDefault();
        const form = e.target;
        const { data } = Csv.parse(form.content.value);

        if (data.length == 0) return;

        const table = build_table(data);
        const superTable = cec('super-table')();
        superTable.append(table);
        csvInput.after(superTable);
        form.closest('section').dataset.stage = 'table';
      });
    }

    {
      const section = document.querySelector('section[data-name=combined]');
      const button = section.querySelector('button[name=generate]');
      button.addEventListener('click', (e) => {
        const nickname_map_table = document.querySelector('section[data-filename=discord_id_to_nickname] super-table');
        const nickname_headers = [];
        const id_to_nickname_map = {};
        if (nickname_map_table) {
          const nickname_data = nickname_map_table.getData();
          if (nickname_data[0][0] != 'discordUserId') {
            alert('unknown nickname table format, expected discordUserId first');
          } else {
            nickname_headers.push(...nickname_data[0].slice(1));
            for (let i = 1; i < nickname_data.length; i++) {
              const row = nickname_data[i];
              const id = row[0];
              id_to_nickname_map[id] = row.slice(1);
            }
          }
        }

        const reactions_table = document.querySelector('section[data-filename=message_reactions] super-table');
        const reactions = reactions_table.getData();
        const reaction_headers = reactions[0];
        const emoji_column = 0;
        if (reaction_headers[emoji_column] != 'emoji' || reaction_headers[1] != 'discordUserId') {
          alert('Unknown reaction table format, expected first column to be emoji');
          return;
        }

        const emoji_list = [];
        const emoji_index = {};
        for (let i = 1; i < reactions.length; i++) {
          const emoji = reactions[i][emoji_column];
          if (emoji_index[emoji] == null) {
            emoji_index[emoji] = emoji_list.length;
            emoji_list.push(emoji);
          }
        }

        const final_headers = reaction_headers.slice(1);
        final_headers.push(...nickname_headers);
        final_headers.push(...emoji_list);
        const empty_nickname = Array(nickname_headers.length).fill('');
        const empty_emojis = Array(emoji_list.length).fill('');
        const id_to_row = {};
        const rows = [final_headers];
        for (let i = 1; i < reactions.length; i++) {
          const emoji = reactions[i][emoji_column];
          const id = reactions[i][1];
          let row = id_to_row[id];
          if (!row) {
            row = reactions[i].slice(1);
            row.push(...(id_to_nickname_map[id] ?? empty_nickname));
            row.push(...empty_emojis);
            id_to_row[id] = row;
            rows.push(row);
          }
          row[final_headers.length - emoji_list.length + emoji_index[emoji]] = '1';
        }

        const table = build_table(rows);
        const superTable = cec('super-table')();
        superTable.append(table);
        section.querySelector('super-table')?.remove();
        section.append(superTable);
      });
    }
    {
      const section = document.querySelector('section[data-name="reformat"]');
      const select_button = section.querySelector('button[name="select"]');
      const reset_button = section.querySelector('button[name="reset"]');
      const add_button = section.querySelector('button[name="add"]');
      const generate_button = section.querySelector('button[name="generate"]');
      let add_button_click;
      select_button.addEventListener('click', (e) => {
        e.preventDefault();
        const combined_table =
          document.querySelector('section[data-name="combined"] super-table');
        const data = combined_table.getData();
        const headers = data[0];
        const header_select = cec('select')();
        header_select.append(...headers.map(cec('option')));
        {
          const inclusion_column_select = header_select.cloneNode(true);
          inclusion_column_select.setAttribute('name', 'inclusion_column');
          const include_all = cec('option')('-- Include all --');
          include_all.setAttribute('value', '');
          include_all.setAttribute('selected', true);
          inclusion_column_select.prepend(include_all);
          const label = cec('label')('Include if column truthy: ');
          label.append(inclusion_column_select);
          reset_button.after(label);
        }
        add_button_click = (e) => {
          e.preventDefault();
          const p = cec('p')(' renamed to ');
          const column_select = header_select.cloneNode(true);
          const input = cec('input')();
          const column_change = () => {
            input.placeholder = column_select.options[column_select.selectedIndex].text;
          };
          column_select.addEventListener('change', column_change);
          column_change();
          const remove = cec('button')();
          remove.innerHTML = '&#10006;';
          remove.addEventListener('click', (e) => {
            e.preventDefault();
            p.remove();
          });
          p.prepend(column_select);
          p.append(input, ' ', remove);
          add_button.before(p);
        };
        add_button.addEventListener('click', add_button_click);
        section.dataset.step = 'columns';
      });
      reset_button.addEventListener('click', (e) => {
        e.preventDefault();
        while (reset_button.nextSibling != add_button) {
          reset_button.nextSibling.remove();
        }
        add_button.removeEventListener('click', add_button_click);
        section.dataset.step = 'start';
      });
      generate_button.addEventListener('click', (e) => {
        e.preventDefault();
        const combined_table =
          document.querySelector('section[data-name="combined"] super-table');
        const data = combined_table.getData();
        const headers = data[0];
        console.log({headers});
        const data_only = data.slice(1);
        let filter = () => true;
        {
          const inclusion_column_select = section.querySelector('select[name=inclusion_column]');
          console.log({select_value: inclusion_column_select.value});
          const value = inclusion_column_select.value;
          if (value != '') {
            const col_index = headers.indexOf(value);
            console.log({col_index});
            filter = (row) => !!row[col_index];
          }
        }
        const ps = section.querySelectorAll('p');
        const col_getters = [];
        const final_headers = [];
        for (let p of ps) {
          const select = p.querySelector('select');
          console.log({select_value: select.value});
          const col_index = headers.indexOf(select.value);
          console.log({col_index});
          col_getters.push((row) => row[col_index]);
          const input = p.querySelector('input');
          const input_value = input.value;
          final_headers.push(input_value ? input_value : input.placeholder);
        }
        const final_data = [final_headers];
        final_data.push(...data_only.filter(filter).map((row) => col_getters.map((f) => f(row))));
        const table = build_table(final_data);
        const superTable = cec('super-table')();
        superTable.dataset.filename = 'attendance';
        superTable.append(table);
        section.querySelector('super-table')?.remove();
        section.append(superTable);
      });
    }
  </script>
  <script type="module">
    let localStorage;
    try {
      localStorage = window.localStorage;
      localStorage.removeItem('test');
      if (localStorage.getItem('test')) throw 'fail';
      localStorage.setItem('test', 'test');
      if (localStorage.getItem('test') != 'test') throw 'fail';
      localStorage.removeItem('test');
    } catch {
      console.log('Failed to access localStorage.');
      localStorage = null;
    }

    if (localStorage) {
      const sections = document.querySelectorAll('section[data-filename]');
      for (const section of sections) {
        const localStorageKey = section.dataset.filename;
        const csvForm = section.querySelector('csv-input form');
        const storeData = (data) => {
          localStorage.setItem(localStorageKey, data)
        };
        const data = localStorage.getItem(localStorageKey);
        if (data) {
          csvForm.content.value = data;
          csvForm.requestSubmit();
        }

        csvForm.addEventListener('submit', (e) => {
          storeData(e.target.content.value);
        });

        section.addEventListener('super-table-updated', (e) => {
          const superTable = section.querySelector('super-table');
          const csv = superTable.getCsv();
          if (csv) storeData(csv);
        });
      }
      if (
        document.querySelector('section[data-filename=discord_id_to_nickname] super-table')
        && document.querySelector('section[data-filename=message_reactions] super-table')
        ) {
        const generate_button = document.querySelector('section[data-name=combined] button[name=generate]');
        generate_button.click();
      }
    }
  </script>
</body>
</html>
