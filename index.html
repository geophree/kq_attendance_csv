<html lang="en-US">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 10 10%22><text y=%22.9em%22 font-size=%229%22>üëç</text></svg>" />
  <title>KQ Attendance CSV Maker</title>
  <!-- from http://github.com/kevquirk/simple.css -->
  <link rel="stylesheet" href="https://unpkg.com/simpledotcss/simple.css" />
  <style>
    /* make the GitHub icon a normal size */
    .icon {
        vertical-align: sub;
        /* this makes them smaller for some reason:
        padding-right: .25rem; */
        display: inline-block;
        width: 1em;
        height: 1.3em;
        margin-right: 0.2rem;
        stroke-width: 0;
        stroke: currentColor;
        fill: currentColor;
    }

    /* fix some weirdness with buttons in simple.css */
    a.button,
    input[type="submit"],
    input[type="reset"],
    input[type="button"] {
      padding: .5em;
    }

    @media only screen and (max-width: 720px) {
      button, a.button, .button {
        text-align: center;
        width: 100%;
      }
    }

    /* turn off zebra striping of tables */
    tr:nth-child(even) {
      background-color: inherit;
    }

    /* make action-table work better with simple.css */
    action-table {
      th {
        &:has(> button) {
          padding: 0;
        }

        > button {
          text-align: left;
          border: none;
          border-radius: 0;
          /*
          background-color: inherit;
          color: inherit;
          &:hover {
            color: var(--accent-text);
          }
          */
          margin: 0;
          min-width: 100%;
        }
      }
    }

    /* Action table sorting display support */
    action-table {
      th button {
        display: flex;
        column-gap: .5em;
      }

      :where(th button)::after {
        content: "‚≠•";
        margin-left: auto;
        opacity: .3;
      }

      :where(th[aria-sort="descending"] button)::after {
        content: "‚≠£";
        opacity: 1;
      }

      :where(th[aria-sort="ascending"] button)::after {
        content: "‚≠°";
        opacity: 1;
      }

      :where(
          th[aria-sort$="ing"] button,
          th[aria-sort$="ing"]:has(button)
        ) {
        background-color: var(--accent-hover);
      }

      .sorted {
        background-color: var(--accent-bg);
      }
    }

    /* title, search, bottom controls */
    action-table {
      display: block;
      width: fit-content;
      max-width: 100%;

      /* match action-table styles */
      .title, .controls {
        overflow: auto;
        width: 100%;
        font-weight: bold;
        background-color: var(--accent);
        border: var(--border-width) solid var(--border);
        padding: .5rem;
        color: var(--accent-text);
        font-size: medium; /* TODO: hack? */
      }

      /* expanding search */
      .title input[type="search"] {
        float: right;
        margin: 0;
        padding: .25em;

        &::placeholder {
          float: left;
        }

        &:placeholder-shown:not(:focus) {
          width: 2rem;
        }
      }

      .controls {
        display: flex;
        padding-bottom: 0; /* TODO: HACK! */

        :last-child {
          margin-left: auto;
        }

        button, .button {
          width: fit-content;
        }
      }

      &:not(.editing) .controls [name="save"] {
        display: none;
      }

      &.editing .controls [name="edit"] {
        display: none;
      }
    }

    /* scrolling & expanding table */
    action-table {
      .scroller {
        overflow: auto;
        max-height: 50vh;
        width: 100%;

        table {
          min-width: 100%;
          margin: 0;
        }

        /* always show header */
        thead {
          position: sticky;
          top: calc(-1 * var(--border-width));
        }
      }

      .controls label.expanded {
        &::after {
          content: "‚ñº";
        }
        &:has(:checked)::after {
          content: "‚ñ≤";
        }
      }

      &:has(label.expanded :checked) .scroller {
        max-height: none;
      }
    }


    /* my own styles */
    textarea {
      min-height: 10rem;
      /* might want to add this to simple.css for :not([cols]) */
      resize: vertical;
    }
    textarea::placeholder {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    p {
      text-wrap: pretty;
    }
    h1, h2, h3, h4, h5, h6 {
      text-wrap: balance;
    }
  </style>
</head>
<body>
  <header>
    <h1>KQ Attendance CSV Maker</h1>
    <p>A web app to transform the message reaction CSV into the attendance CSV.</p>
  </header>
  <main>
    <action-table>
      <div class="title">
        Discord Id to Server Nickname
        <action-table-filters>
          <input type="search" name="action-table" placeholder="üîç" />
        </action-table-filters>
      </div>
      <div class="scroller">
        <table>
          <thead><th>discordUserId</th><th>discordUserId2</th><th>serverNickname</th></thead>
          <tbody>
            <tr><td>587725272850366464</td><td>587725272850366464</td><td>dangief</td></tr>
            <tr><td>349002497823604749</td><td>349002497823604749</td><td>2kool4u2k9</td></tr>
            <tr><td>334551284860583937</td><td>334551284860583937</td><td>aaron</td></tr>
            <tr><td>187409274157137920</td><td>187409274157137920</td><td>Abby [bmore]</td></tr>
            <tr><td>109082939316269056</td><td>109082939316269056</td><td>Agador</td></tr>
            <tr><td>204019581654663170</td><td>204019581654663170</td><td>Amphibious Mommy Milkers</td></tr>
            <tr><td>148995687059685376</td><td>148995687059685376</td><td>Andy</td></tr>
            <tr><td>176849766653755392</td><td>176849766653755392</td><td>antipode</td></tr>
            <tr><td>205161308553871360</td><td>205161308553871360</td><td>anxpara</td></tr>
            <tr><td>478681860084465665</td><td>478681860084465665</td><td>Aquafox - Sam</td></tr>
            <tr><td>331647057125441546</td><td>331647057125441546</td><td>Arguas (Ryan)</td></tr>
            <tr><td>174669097039167489</td><td>174669097039167489</td><td>Arioid</td></tr>
            <tr><td>398656868282662914</td><td>398656868282662914</td><td>Asher</td></tr>
            <tr><td>310786667030249472</td><td>310786667030249472</td><td>atlas ‚Å∂‚Å∂‚Å∂</td></tr>
          </tbody>
        </table>
      </div>
      <form class="controls">
        <button name="copy"><svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 448 512"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2026 Fonticons, Inc.--><path d="M192 0c-35.3 0-64 28.7-64 64l0 256c0 35.3 28.7 64 64 64l192 0c35.3 0 64-28.7 64-64l0-200.6c0-17.4-7.1-34.1-19.7-46.2L370.6 17.8C358.7 6.4 342.8 0 326.3 0L192 0zM64 128c-35.3 0-64 28.7-64 64L0 448c0 35.3 28.7 64 64 64l192 0c35.3 0 64-28.7 64-64l0-16-64 0 0 16-192 0 0-256 16 0 0-64-16 0z"/></svg></button>
        <button name="download"><svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 448 512"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2026 Fonticons, Inc.--><path d="M256 32c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 210.7-41.4-41.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l96 96c12.5 12.5 32.8 12.5 45.3 0l96-96c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L256 242.7 256 32zM64 320c-35.3 0-64 28.7-64 64l0 32c0 35.3 28.7 64 64 64l320 0c35.3 0 64-28.7 64-64l0-32c0-35.3-28.7-64-64-64l-46.9 0-56.6 56.6c-31.2 31.2-81.9 31.2-113.1 0L110.9 320 64 320zm304 56a24 24 0 1 1 0 48 24 24 0 1 1 0-48z"/></svg></button>
        <button name="add_row"><svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 448 512"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2026 Fonticons, Inc.--><path d="M256 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 160-160 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l160 0 0 160c0 17.7 14.3 32 32 32s32-14.3 32-32l0-160 160 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-160 0 0-160z"/></svg></button>
        <button name="edit"><svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 512 512"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2026 Fonticons, Inc.--><path d="M471.6 21.7c-21.9-21.9-57.3-21.9-79.2 0L368 46.1 465.9 144 490.3 119.6c21.9-21.9 21.9-57.3 0-79.2L471.6 21.7zm-299.2 220c-6.1 6.1-10.8 13.6-13.5 21.9l-29.6 88.8c-2.9 8.6-.6 18.1 5.8 24.6s15.9 8.7 24.6 5.8l88.8-29.6c8.2-2.7 15.7-7.4 21.9-13.5L432 177.9 334.1 80 172.4 241.7zM96 64C43 64 0 107 0 160L0 416c0 53 43 96 96 96l256 0c53 0 96-43 96-96l0-96c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7-14.3 32-32 32L96 448c-17.7 0-32-14.3-32-32l0-256c0-17.7 14.3-32 32-32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L96 64z"/></svg></button>
        <button name="save"><svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 448 512"><!--!Font Awesome Free v5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2026 Fonticons, Inc.--><path d="M433.941 129.941l-83.882-83.882A48 48 0 0 0 316.118 32H48C21.49 32 0 53.49 0 80v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V163.882a48 48 0 0 0-14.059-33.941zM224 416c-35.346 0-64-28.654-64-64 0-35.346 28.654-64 64-64s64 28.654 64 64c0 35.346-28.654 64-64 64zm96-304.52V212c0 6.627-5.373 12-12 12H76c-6.627 0-12-5.373-12-12V108c0-6.627 5.373-12 12-12h228.52c3.183 0 6.235 1.264 8.485 3.515l3.48 3.48A11.996 11.996 0 0 1 320 111.48z"/></svg></button>
        <label class="expanded button"><input type="checkbox" style="display: none" /></label>
      </form>
    </action-table>
    <form action="javascript:void(0);">
      <!-- TODO: looks bad on mobile -->
      <fieldset>
      <legend>Discord Id to server nickname mapping</legend>
      <textarea name="content" placeholder="Paste or drop CSV data or file"></textarea>
      <input type="submit"value="Use Text" />
      <label class="button">Use Local File<input type="file" style="display: none" accept="text/*" /></label>
      </fieldset>
    </form>
  </main>
  <footer>
    <nav>
      <a href="https://github.com/geophree/kq_attendance_csv"><svg class="icon" viewBox="0 0 32 32"><path d="M16 0.395c-8.836 0-16 7.163-16 16 0 7.069 4.585 13.067 10.942 15.182 0.8 0.148 1.094-0.347 1.094-0.77 0-0.381-0.015-1.642-0.022-2.979-4.452 0.968-5.391-1.888-5.391-1.888-0.728-1.849-1.776-2.341-1.776-2.341-1.452-0.993 0.11-0.973 0.11-0.973 1.606 0.113 2.452 1.649 2.452 1.649 1.427 2.446 3.743 1.739 4.656 1.33 0.143-1.034 0.558-1.74 1.016-2.14-3.554-0.404-7.29-1.777-7.29-7.907 0-1.747 0.625-3.174 1.649-4.295-0.166-0.403-0.714-2.030 0.155-4.234 0 0 1.344-0.43 4.401 1.64 1.276-0.355 2.645-0.532 4.005-0.539 1.359 0.006 2.729 0.184 4.008 0.539 3.054-2.070 4.395-1.64 4.395-1.64 0.871 2.204 0.323 3.831 0.157 4.234 1.026 1.12 1.647 2.548 1.647 4.295 0 6.145-3.743 7.498-7.306 7.895 0.574 0.497 1.085 1.47 1.085 2.963 0 2.141-0.019 3.864-0.019 4.391 0 0.426 0.288 0.925 1.099 0.768 6.354-2.118 10.933-8.113 10.933-15.18 0-8.837-7.164-16-16-16z"></path></svg>GitHub</a>
    </nav>
  </footer>
  <script type="module" src="https://unpkg.com/@colinaut/action-table/dist/index.js"></script>
  <script type="module">
    import Csv from "./papaparse.js";
    // accept pasted, dropped, or file-selected text or files.
    const form = document.querySelector('form:has(textarea)');
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const form = e.target;
      const { data } = Csv.parse(form.content.value);

      if (data.length == 0) return;
      const cec = (name) => (text) => {
        const el = document.createElement(name);
        if (text) el.textContent = text;
        return el;
      }
      const table = cec('table')();
      const thead = cec('thead')();
      thead.append(...data[0].map(cec('th')));
      table.append(thead);

      const tbody = cec('tbody')();
      if (data.length > 1) {
        for (let i = 1; i < data.length; i++) {
          const tr = cec('tr')();
          tr.append(...data[i].map(cec('td')));
          tbody.appendChild(tr);
        }
      }
      table.append(tbody);

      const actionTable = cec('action-table')();
      actionTable.append(table);
      form.after(actionTable);
      // use contenteditable="plaintext-only" for edit
    });
    const processItem = async (item, form) => {
      if (!item) return;
      if (item.kind === 'file') item = item.getAsFile();
      if (item.kind === 'string') {
        item = await new Promise((res) => item.getAsString(res));
      }
      if (item instanceof Blob) item = await item.text();
      if (typeof item === 'string') {
        form.content.value = item;
        form.requestSubmit();
      } else {
        console.error({message: 'item not DataTransferItem, Blob/File, or string', item});
      }
    };
    // TODO: check for (save to) localStorage?
    // TODO: support google sheets
    // TODO: submit event handling
    // TODO: https://github.com/colinaut/action-table for tables

    const findBestItem = (dataTransfer) => {
      // "CSV"-like mime types:
      // text/csv
      // application/csv
      // text/comma-separated-values
      // text/tab-separated-values

      let index = -1;
      let best = { index, isFile: false, isText: false, isCsv: false };
      for (const i of dataTransfer.items) {
        index++;
        const isFile = i.kind === 'file';
        if (!isFile && i.kind !== 'string') continue;
        const current = {
          index,
          isFile,
          isText: i.type.startsWith('text'),
          isCsv: !!i.type.match(
            '^(text|application)/(csv|(comma|tab)-separated-values)'
          ),
        };
        // if there are any files, ignore non-files
        if (best.isFile != current.isFile) {
          if (current.isFile) best = current;
          continue;
        }
        if (best.isCsv != current.isCsv) {
          if (current.isCsv) best = current;
          continue;
        }
        if (!best.isText && current.isText) best = current;
      }
      if (best.index != -1 && (best.isText || best.isCsv)) {
        return dataTransfer.items[best.index];
      }
      return null;
    };

    form.addEventListener('dragover', e => {
      const bestItem = findBestItem(e.dataTransfer);
      if (!bestItem) return;
      e.preventDefault();
      e.dataTransfer.dropEffect = "copy";
    });

    form.addEventListener('drop', e => {
      e.preventDefault();
      const bestItem = findBestItem(e.dataTransfer);
      if (!bestItem) return;
      processItem(bestItem, e.currentTarget.closest('form'));
    });

    form.addEventListener('paste', e => {
      const bestItem = findBestItem(e.clipboardData);
      if (bestItem?.kind !== 'file') return;
      e.preventDefault();
      processItem(bestItem, e.currentTarget.closest('form'));
    });

    const fileInput = form.querySelector('input[type=file]');
    fileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      e.target.value = null;
      processItem(file, e.currentTarget.closest('form'));
    });
  </script>
</body>
</html>
